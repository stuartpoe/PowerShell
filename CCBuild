$tenantID = '825d9ed3-9216-4a99-a96b-d09234511756' 
$SubID = 'b6ae4379-bd04-481e-904a-32052674296b'
$loc ='EastUS2'

$rgCC = 'rg-cyclecloud'
$rgnetwork ='rg-networking'
$rgstorage = 'rg-storage'

$vnet ='vnet-cyclecloud'
$subnet1 =New-AzVirtualNetworkSubnetConfig -Name Subnet1 -AddressPrefix "10.0.1.0/24"
$subnet2 =New-AzVirtualNetworkSubnetConfig -Name Subnet2 -AddressPrefix "10.0.2.0/24"
$subnet3 =New-AzVirtualNetworkSubnetConfig -Name Subnet3 -AddressPrefix "10.0.3.0/24"

$storage ='cyccldstoragetst'
$storagesku = 'Standard_LRS'
#$ctx= New-AzStorageContext -ResourceGroupName $rgstorage -Name $storage -Location $loc -SkuName $storagesku
#$container = "cyclecloud"


#Connect-AzAccount -Tenant $tenantID -SubscriptionId $SubID

#CycleCloud
New-AzResourceGroup -name $rgCC -Location $loc

#Networking
New-AzResourceGroup -name $rgnetwork -Location $loc
New-AzVirtualNetwork -name $vnet  -ResourceGroupName $rgnetwork -Location $loc -AddressPrefix '10.0.0.0/22' -Subnet $Subnet1,$Subnet2,$subnet3


#Storage
New-AzResourceGroup -name $rgstorage -Location $loc
New-AzStorageAccount -ResourceGroupName $rgstorage -Name $storage -Location $loc -SkuName $storagesku
#New-AzStorageContainer -Name $container  -Permission Off -Context $ctx

#VM Params
#$adminUsername = Read-Host 'Admin username'
#$adminPassword = Read-Host -AsSecureString 'Admin password with least 12 characters'

$AdminUsername = "adminuser"
$AdminPassword = ConvertTo-SecureString "Password@123" -AsPlainText -Force

$adminCreds    = New-Object PSCredential $adminUsername, $adminPassword


$Subnet = Get-AzVirtualNetwork -name $vnet | Get-AzVirtualNetworkSubnetConfig -Name $SubnetName
$Nic = New-AzNetworkInterface -ResourceGroupName $rgCC -Name "$VMName-nic" -Location $Loc -SubnetId $Subnet.Id
$SubnetName = "subnet2"

#VMConfig 
$VMName = "vm-CycleCloud1"
$VMSize = "Standard_DS1_v2"
$ImagePublisher = "Canonical"
$ImageOffer = "UbuntuServer"
$ImageSku = "18.04-LTS"
$VMConfig = New-AzVMConfig -VMName $VMName -VMSize $VMSize
$VMConfig = Set-AzVMOperatingSystem -VM $VMConfig -Linux -ComputerName $VMName -Credential $adminCreds
$VMConfig = Set-AzVMSourceImage -VM $VMConfig -PublisherName $ImagePublisher -Offer $ImageOffer -Skus $ImageSku -Version "latest"
$VMConfig = Add-AzVMNetworkInterface -VM $VMConfig -Id $Nic.Id

# Create the VM
New-AzVM -ResourceGroupName $rgCC -Location $Loc -VM $VMConfig
